/* ----------------------------------------------------------------------
** Include Files
** ------------------------------------------------------------------- */
#include "HRZ_ADS1298_LP_Filter.h"
#include "HRZ_ecg_service.h"

/* ----------------------------------------------------------------------
** Macro Defines
** ------------------------------------------------------------------- */
#define TEST_LENGTH_SAMPLES HRZ_SAMPLES_PER_PACKET
#define BLOCK_SIZE HRZ_SAMPLES_PER_PACKET
#define NUM_TAPS 51

/* -------------------------------------------------------------------
 * Declare State buffer of size (numTaps + blockSize - 1)
 * ------------------------------------------------------------------- */
static q31_t firStateQ32[BLOCK_SIZE + NUM_TAPS - 1];
/* ----------------------------------------------------------------------
** FIR Coefficients buffer generated using fir1() MATLAB function.
** fir1(28, 6/24)
** ------------------------------------------------------------------- */
const q31_t firCoeffs32[NUM_TAPS] = {
    4158953,    950964,     -4232783,   -6578138,   -1559207,  8836999,
    13754268,   2814607,    -18552305,  -27190850,  -4542809,  35506542,
    49174469,   6501865,    -63506119,  -84347414,  -8416452,  111587452,
    145394252,  10016893,   -210491263, -284274503, -11077457, 577461757,
    1184842216, 1442503420, 1184842216, 577461757,  -11077457, -284274503,
    -210491263, 10016893,   145394252,  111587452,  -8416452,  -84347414,
    -63506119,  6501865,    49174469,   35506542,   -4542809,  -27190850,
    -18552305,  2814607,    13754268,   8836999,    -1559207,  -6578138,
    -4232783,   950964,     4158953

};
/* ------------------------------------------------------------------
 * Global variables for FIR LPF Example
 * ------------------------------------------------------------------- */
uint32_t blockSize = BLOCK_SIZE;
uint32_t numBlocks = TEST_LENGTH_SAMPLES / BLOCK_SIZE;
/* ----------------------------------------------------------------------
 * FIR LPF Example
 * ------------------------------------------------------------------- */
arm_status hrz_ads1298_filter_data(q31_t *inputF32, q31_t *outputF32) {
  uint32_t i;
  arm_fir_instance_q31 S;

  /* Call FIR init function to initialize the instance structure. */
  arm_fir_init_q31(&S, NUM_TAPS, (q31_t *)&firCoeffs32[0], &firStateQ32[0],
                   blockSize);
  /* ----------------------------------------------------------------------
  ** Call the FIR process function for every blockSize samples
  ** ------------------------------------------------------------------- */
  for (i = 0; i < numBlocks; i++) {
    arm_fir_q31(&S, inputF32 + (i * blockSize), outputF32 + (i * blockSize),
                blockSize);
  }

  return ARM_MATH_SUCCESS;
}
